<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Clipping</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        video { display: block; margin-bottom: 20px; }
        label { display: block; margin: 5px 0; }
        #container { position: relative; display: inline-block; }
        #hover_display {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 2px 4px;
            font-size: 12px;
        }
    </style>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
<div id="app">
    <h1>AWS MediaLive Clipping</h1>

    <div id="container">
        <video ref="video" width="640" controls autoplay
               @mousemove="onVideoMove" @mouseleave="hoverDisplayVisible=false">
            <source src="{{ video_url }}" type="application/vnd.apple.mpegurl">
            Your browser does not support the video tag.
        </video>
        <div id="hover_display" v-if="hoverDisplayVisible">{{ hoverDisplayText }}</div>
    </div>

    <div>
        <label>Start Time (UTC): <input type="text" v-model="start"></label>
        <button @click="setStartNow">Set Start to Now</button>
        <button @click="setStartFrame">Set Start Here</button>
    </div>
    <div>
        <label>End Time (UTC): <input type="text" v-model="end"></label>
        <button @click="setEndNow">Set End to Now</button>
        <button @click="setEndFrame">Set End Here</button>
    </div>
    <div>
        <label>Endpoint ID: <input type="text" v-model="endpoint_id"></label>
    </div>
    <div>
        <label>Bucket: <input type="text" v-model="bucket"></label>
    </div>
    <div>
        <label>Manifest Prefix: <input type="text" v-model="manifest_prefix"></label>
    </div>
    <div>
        <label>Clip Title: <input type="text" v-model="title"></label>
    </div>
    <div>
        <label>Role ARN: <input type="text" v-model="role_arn"></label>
    </div>
    <div>
        <label>Region: <input type="text" v-model="region"></label>
    </div>

    <button @click="createClip">Create Clip</button>
    <button @click="previewClip">Preview Clip</button>

    <pre>{{ result }}</pre>
</div>

<script>
const { createApp, ref } = Vue;

createApp({
    setup() {
        const video = ref(null);
        const hoverDisplayVisible = ref(false);
        const hoverDisplayText = ref('');
        const hoverSeconds = ref(0);
        const startSeconds = ref(0);
        const endSeconds = ref(0);

        const start = ref('');
        const end = ref('');
        const endpoint_id = ref('');
        const bucket = ref('');
        const manifest_prefix = ref('');
        const title = ref('');
        const role_arn = ref('');
        const region = ref('us-east-1');
        const result = ref('');

        const formatTime = sec => {
            const s = Math.floor(sec);
            const h = String(Math.floor(s / 3600)).padStart(2, '0');
            const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
            const secs = String(s % 60).padStart(2, '0');
            const ms = String(Math.floor((sec - s) * 1000)).padStart(3, '0');
            return `${h}:${m}:${secs}.${ms}`;
        };

        const onVideoMove = e => {
            const rect = video.value.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percent = x / rect.width;
            hoverSeconds.value = percent * video.value.duration;
            hoverDisplayText.value = formatTime(hoverSeconds.value);
            hoverDisplayVisible.value = true;
        };

        const isoFromCurrent = seconds => {
            const now = new Date();
            const diff = video.value.currentTime - seconds;
            return new Date(now.getTime() - diff * 1000).toISOString().slice(0, 23);
        };

        const setStartNow = () => {
            start.value = new Date().toISOString().slice(0, 23);
        };

        const setEndNow = () => {
            end.value = new Date().toISOString().slice(0, 23);
        };

        const setStartFrame = () => {
            startSeconds.value = hoverSeconds.value;
            start.value = isoFromCurrent(hoverSeconds.value);
        };

        const setEndFrame = () => {
            endSeconds.value = hoverSeconds.value;
            end.value = isoFromCurrent(hoverSeconds.value);
        };

        const previewClip = () => {
            if (!video.value) return;
            video.value.currentTime = startSeconds.value;
            video.value.play();
            const handler = () => {
                if (video.value.currentTime >= endSeconds.value) {
                    video.value.pause();
                    video.value.removeEventListener('timeupdate', handler);
                }
            };
            video.value.addEventListener('timeupdate', handler);
        };

        const createClip = async () => {
            const payload = {
                endpoint_id: endpoint_id.value,
                start: start.value,
                end: end.value,
                bucket: bucket.value,
                manifest_prefix: manifest_prefix.value,
                title: title.value,
                role_arn: role_arn.value,
                region: region.value
            };
            const res = await fetch('/clip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            result.value = JSON.stringify(data, null, 2);
        };

        return {
            video,
            hoverDisplayVisible,
            hoverDisplayText,
            start,
            end,
            endpoint_id,
            bucket,
            manifest_prefix,
            title,
            role_arn,
            region,
            result,
            setStartNow,
            setEndNow,
            setStartFrame,
            setEndFrame,
            onVideoMove,
            previewClip,
            createClip
        };
    }
}).mount('#app');
</script>
</body>
</html>
